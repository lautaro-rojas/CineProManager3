version: '3.8'

services:
  # ==========================================
  # AMBIENTE: DEVELOPMENT
  # URL Local: http://localhost:5001
  # ==========================================
  app-dev:
    container_name: cinepro_app_dev
    build:
      context: .
      dockerfile: WebApplication1/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      # La cadena de conexión debe apuntar al nombre del servicio de la DB (db-dev)
      - ConnectionStrings__DefaultConnection=Server=db-dev;Database=CinePro_Dev;User Id=sa;Password=TuPasswordFuerte123!;TrustServerCertificate=True;
    ports:
      - "5001:8080"
    depends_on:
      - db-dev
    restart: unless-stopped

  db-dev:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: cinepro_db_dev
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=TuPasswordFuerte123!
    volumes:
      - sql_data_dev:/var/opt/mssql

  # ==========================================
  # AMBIENTE: TEST
  # URL Local: http://localhost:5002
  # ==========================================
  app-test:
    container_name: cinepro_app_test
    build:
      context: .
      dockerfile: WebApplication1/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Test
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=db-test;Database=CinePro_Test;User Id=sa;Password=TuPasswordFuerte123!;TrustServerCertificate=True;
    ports:
      - "5002:8080"
    depends_on:
      - db-test
    restart: unless-stopped

  db-test:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: cinepro_db_test
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=TuPasswordFuerte123!
    volumes:
      - sql_data_test:/var/opt/mssql

  # ==========================================
  # AMBIENTE: PRE-PROD
  # URL Local: http://localhost:5003
  # ==========================================
  app-preprod:
    container_name: cinepro_app_preprod
    build:
      context: .
      dockerfile: WebApplication1/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=PreProd
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=db-preprod;Database=CinePro_PreProd;User Id=sa;Password=TuPasswordFuerte123!;TrustServerCertificate=True;
    ports:
      - "5003:8080"
    depends_on:
      - db-preprod
    restart: unless-stopped

  db-preprod:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: cinepro_db_preprod
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=TuPasswordFuerte123!
    volumes:
      - sql_data_preprod:/var/opt/mssql

  # ==========================================
  # AMBIENTE: PRODUCTION
  # URL Local: http://localhost:5004
  # ==========================================
  app-prod:
    container_name: cinepro_app_prod
    build:
      context: .
      dockerfile: WebApplication1/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=db-prod;Database=CinePro_Prod;User Id=sa;Password=TuPasswordFuerte123!;TrustServerCertificate=True;
    ports:
      - "5004:8080"
    depends_on:
      - db-prod
    restart: always

  db-prod:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: cinepro_db_prod
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=TuPasswordFuerte123!
    volumes:
      - sql_data_prod:/var/opt/mssql

volumes:
  sql_data_dev:
  sql_data_test:
  sql_data_preprod:
  sql_data_prod: